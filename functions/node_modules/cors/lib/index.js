// public
module.exports = cors;

// private
var defaults = require('./defaults');
var isOptions = require('./is-options');
var isString = require('./is-string');

function cors(options, req, res, next) {
  if (isOptions(options)) {
    // cors(options)
    return function(req, res, next) {
      cors(options, req, res, next);
    };
  } else {
    // cors(req, res, next)
    next = res;
    res = req;
    req = options;
    options = null;

    var origin = process.env.CORS_ORIGIN || 'https://darkdesire.pt';
    var methods = process.env.CORS_METHODS || 'GET,HEAD,PUT,PATCH,POST,DELETE';
    var headers = process.env.CORS_HEADERS;
    var credentials = process.env.CORS_CREDENTIALS || true;
    var maxAge = process.env.CORS_MAX_AGE;
    var exposedHeaders = process.env.CORS_EXPOSED_HEADERS;

    options = {
      origin: origin,
      methods: methods,
      headers: headers,
      credentials: credentials,
      maxAge: maxAge,
      exposedHeaders: exposedHeaders
    };

    var requestOrigin = req.headers.origin;

    if (isString(requestOrigin) && (origin === '*' || requestOrigin.indexOf(origin) > -1)) {
      res.setHeader('Access-Control-Allow-Origin', requestOrigin);
    }

    if (credentials === true) {
      res.setHeader('Access-Control-Allow-Credentials', 'true');
    }

    if (exposedHeaders) {
      res.setHeader('Access-Control-Expose-Headers', exposedHeaders);
    }

    if (req.method === 'OPTIONS') {
      if (methods) {
        res.setHeader('Access-Control-Allow-Methods', methods);
      }

      if (headers) {
        res.setHeader('Access-Control-Allow-Headers', headers);
      } else {
        res.setHeader('Access-Control-Allow-Headers', req.headers['access-control-request-headers']);
      }

      if (maxAge) {
        res.setHeader('Access-Control-Max-Age', maxAge);
      }

      res.statusCode = 204;
      res.end();
    } else {
      next();
    }
  }
}
