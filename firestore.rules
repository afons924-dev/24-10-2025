rules_version = '2';
service cloud.firestore {
  // Função auxiliar para verificar se o utilizador é um administrador,
  // lendo o campo 'isAdmin' no seu documento de perfil.
  function isAdmin() {
    // Esta função verifica se o utilizador está autenticado e se o seu documento na coleção 'users'
    // tem o campo 'isAdmin' definido como o valor booleano 'true'.
    return request.auth != null && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.isAdmin == true;
  }

  match /databases/{database}/documents {

    // Produtos: Leitura pública, escrita apenas para admins.
    match /products/{productId} {
      allow read: if true;
      allow create, update, delete: if isAdmin();
    }

    // Utilizadores: Cada utilizador pode gerir o seu próprio documento. Admins podem ler a lista de utilizadores.
    match /users/{userId} {
      allow read, update, write: if request.auth.uid == userId;
      allow list, read: if isAdmin(); // Adicionado 'read' para que admins possam ver perfis individuais.
    }

    // Encomendas: Admins podem listar e gerir todas. Utilizadores só podem ler as suas próprias.
    match /orders/{orderId} {
      allow list, read, update: if isAdmin(); // Acesso total para admins.
      allow read: if request.auth.uid == resource.data.userId; // Utilizador pode ler a sua própria encomenda.
      allow create, delete: if false; // Apenas as Cloud Functions podem criar/apagar.
    }

    // Avaliações: Admins podem gerir todas. O público pode ler as aprovadas. Utilizadores podem criar e ler as suas.
    match /product_ratings/{ratingId} {
      allow list, read, update, delete: if isAdmin();
      allow read: if resource.data.status == 'approved' || (request.auth != null && request.auth.uid == resource.data.userId);
      allow create: if request.auth.uid != null;
    }

    // Mensagens de Contacto: O público pode criar, admins podem gerir.
    match /contact_messages/{messageId} {
      allow create: if true;
      allow read, list, update, delete: if isAdmin();
    }

    // Subscrições de Newsletter: O público pode criar, admins podem gerir.
    match /newsletter_subscriptions/{subscriptionId} {
      allow create: if true;
      allow read, list, update, delete: if isAdmin();
    }

    // Promoção Relâmpago: Leitura pública, escrita para admins.
    match /flash_sale/current {
        allow read: if true;
        allow write: if isAdmin();
    }

    // Coleções internas, sem acesso do cliente.
    match /notifications/{notificationId} {
      allow create: if true;
      allow read, update, delete: if false;
    }
     match /stripe_sessions/{sessionId} {
        allow read, write: if false;
     }
  }
}
