rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Allow public read-only access to products.
    match /products/{productId} {
      allow read: if true;
      allow write: if request.auth.uid != null && request.auth.token.isAdmin == true;
    }

    // Allow users to create notification requests, but not read, update or delete them.
    // This is a public-facing feature.
    match /notifications/{notificationId} {
      allow create: if true;
      allow read, update, delete: if false;
    }

    // Allow users to read and write to their own user document.
    match /users/{userId} {
      allow read, update, write: if request.auth.uid == userId;
    }

    // Allow users to read and write their own orders.
    match /orders/{orderId} {
        allow read, write: if request.auth.uid == resource.data.userId;
    }

    // Allow admin to read all orders
    match /orders/{orderId} {
        allow read: if request.auth.uid != null && request.auth.token.isAdmin == true;
    }

    // Allow public read-only access to approved product ratings, and let users read their own ratings.
    match /product_ratings/{ratingId} {
      allow read: if resource.data.status == 'approved' || (request.auth != null && request.auth.uid == resource.data.userId);
      allow create: if request.auth.uid != null;
      allow update, delete: if request.auth.uid != null && request.auth.token.isAdmin == true;
    }

    // Allow public read-only access to flash sale.
    match /flash_sale/current {
        allow read: if true;
        allow write: if request.auth.uid != null && request.auth.token.isAdmin == true;
    }

    // Allow admin to write to contact messages, newsletter subscriptions
     match /contact_messages/{messageId} {
        allow write: if request.auth.uid != null && request.auth.token.isAdmin == true;
     }

     match /newsletter_subscriptions/{subscriptionId} {
        allow write: if request.auth.uid != null && request.auth.token.isAdmin == true;
     }
  }
}
